<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SimBaseball Admin</title>
  <link rel="stylesheet" href="{{ url_for('admin.static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>

<body>
  <!-- Sidebar Navigation -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1>SimBaseball</h1>
      <span class="version">API Admin</span>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Overview</div>
      <a href="#" class="nav-item active" data-section="dashboard">
        <span class="nav-icon">&#9632;</span> Dashboard
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Game Management</div>
      <a href="#" class="nav-item" data-section="synthetic">
        <span class="nav-icon">&#9881;</span> Synthetic Games
      </a>
      <a href="#" class="nav-item" data-section="tasks">
        <span class="nav-icon">&#9203;</span> Background Tasks
      </a>
      <a href="#" class="nav-item" data-section="simulate">
        <span class="nav-icon">&#9654;</span> Simulate Week
      </a>
      <a href="#" class="nav-item" data-section="timestamp">
        <span class="nav-icon">&#128339;</span> Timestamp
      </a>
      <a href="#" class="nav-item" data-section="rating-config">
        <span class="nav-icon">&#127919;</span> Rating Config
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Data Browser</div>
      <a href="#" class="nav-item" data-section="organizations">
        <span class="nav-icon">&#127970;</span> Organizations
      </a>
      <a href="#" class="nav-item" data-section="teams">
        <span class="nav-icon">&#9917;</span> Teams
      </a>
      <a href="#" class="nav-item" data-section="players">
        <span class="nav-icon">&#9977;</span> Players
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Transactions</div>
      <a href="#" class="nav-item" data-section="tx-roster">
        <span class="nav-icon">&#128259;</span> Roster Moves
      </a>
      <a href="#" class="nav-item" data-section="tx-trades">
        <span class="nav-icon">&#128257;</span> Trades
      </a>
      <a href="#" class="nav-item" data-section="tx-log">
        <span class="nav-icon">&#128220;</span> Transaction Log
      </a>
      <a href="#" class="nav-item" data-section="tx-eos">
        <span class="nav-icon">&#128197;</span> End of Season
      </a>
      <a href="#" class="nav-item" data-section="tx-amateur">
        <span class="nav-icon">&#127891;</span> Amateur Seeding
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Player Engine</div>
      <a href="#" class="nav-item" data-section="pe-generate">
        <span class="nav-icon">&#9889;</span> Generation
      </a>
      <a href="#" class="nav-item" data-section="pe-progress">
        <span class="nav-icon">&#128200;</span> Progression
      </a>
      <a href="#" class="nav-item" data-section="pe-sandbox">
        <span class="nav-icon">&#128300;</span> Sandbox
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Administration</div>
      <a href="#" class="nav-item" data-section="cache">
        <span class="nav-icon">&#128451;</span> Cache Manager
      </a>
      <a href="#" class="nav-item" data-section="sql">
        <span class="nav-icon">&#128190;</span> SQL Console
      </a>
      <a href="#" class="nav-item" data-section="health">
        <span class="nav-icon">&#128153;</span> System Health
      </a>
    </div>

    <div class="sidebar-footer">
      <div class="auth-status" id="auth-status">
        <span class="status-dot offline"></span>
        <span id="auth-text">Not logged in</span>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Bar -->
    <header class="topbar">
      <button class="menu-toggle" id="menu-toggle">&#9776;</button>
      <div class="topbar-title" id="page-title">Dashboard</div>
      <div class="topbar-actions">
        <input type="password" id="admin-password" placeholder="Admin password" />
        <button id="btn-login" class="btn btn-primary">Login</button>
        <button id="btn-logout" class="btn btn-secondary" style="display:none">Logout</button>
      </div>
    </header>

    <!-- Content Sections -->
    <div class="content">

      <!-- Dashboard Section -->
      <section id="section-dashboard" class="section active">
        <div class="grid-3">
          <div class="stat-card">
            <div class="stat-label">Timestamp Status</div>
            <div class="stat-value" id="dash-season">--</div>
            <div class="stat-sub" id="dash-week">Loading...</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Tasks</div>
            <div class="stat-value" id="dash-tasks">--</div>
            <div class="stat-sub">Background jobs</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Database</div>
            <div class="stat-value" id="dash-db">--</div>
            <div class="stat-sub" id="dash-db-status">Checking...</div>
          </div>
        </div>

        <div class="card">
          <h3>Quick Actions</h3>
          <div class="button-group">
            <button class="btn btn-primary" onclick="App.goTo('synthetic')">Generate Synthetic Games</button>
            <button class="btn btn-secondary" onclick="App.goTo('tasks')">View Tasks</button>
            <button class="btn btn-secondary" onclick="App.goTo('cache')">Clear Caches</button>
            <button class="btn btn-secondary" onclick="App.refreshDashboard()">Refresh</button>
          </div>
        </div>

        <div class="card">
          <h3>API Endpoints</h3>
          <div class="endpoint-list">
            <div class="endpoint"><span class="method get">GET</span> <code>/api/v1/games/timestamp</code></div>
            <div class="endpoint"><span class="method get">GET</span> <code>/api/v1/games/debug/synthetic</code></div>
            <div class="endpoint"><span class="method get">GET</span> <code>/api/v1/games/debug/synthetic-async</code></div>
            <div class="endpoint"><span class="method get">GET</span> <code>/api/v1/games/tasks</code></div>
            <div class="endpoint"><span class="method get">GET</span> <code>/api/v1/organizations</code></div>
            <div class="endpoint"><span class="method get">GET</span> <code>/api/v1/teams</code></div>
            <div class="endpoint"><span class="method post">POST</span> <code>/admin/clear-caches</code></div>
          </div>
        </div>
      </section>

      <!-- Synthetic Games Section -->
      <section id="section-synthetic" class="section">
        <div class="card">
          <h3>Generate Synthetic Games</h3>
          <p class="text-muted">Generate random matchups for testing the game engine. For large batches, use async mode.</p>

          <div class="form-grid">
            <div class="form-group">
              <label for="syn-count">Number of Games</label>
              <input type="number" id="syn-count" value="100" min="1" max="10000" />
            </div>
            <div class="form-group">
              <label for="syn-level">League Level</label>
              <select id="syn-level">
                <option value="9" selected>9 - MLB</option>
                <option value="8">8 - AAA</option>
                <option value="7">7 - AA</option>
                <option value="6">6 - A+</option>
                <option value="5">5 - A</option>
              </select>
            </div>
            <div class="form-group">
              <label for="syn-seed">Random Seed (optional)</label>
              <input type="number" id="syn-seed" placeholder="Leave empty for random" />
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" id="btn-syn-async">Generate (Async)</button>
            <button class="btn btn-secondary" id="btn-syn-sync">Generate (Sync - small batches only)</button>
          </div>
        </div>

        <div class="card" id="syn-progress-card" style="display:none">
          <h3>Generation Progress</h3>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="syn-progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text">
              <span id="syn-progress-text">0 / 0</span>
              <span id="syn-progress-pct">0%</span>
            </div>
          </div>
          <div class="progress-status" id="syn-status">Starting...</div>
          <div class="button-group" id="syn-download-group" style="display:none">
            <a class="btn btn-primary" id="syn-download-link" href="#" target="_blank">Download Results</a>
            <button class="btn btn-secondary" onclick="App.goTo('tasks')">View All Tasks</button>
          </div>
        </div>
      </section>

      <!-- Background Tasks Section -->
      <section id="section-tasks" class="section">
        <div class="card">
          <h3>Background Tasks</h3>
          <div class="button-group" style="margin-bottom: 16px">
            <button class="btn btn-secondary" id="btn-refresh-tasks">Refresh</button>
          </div>

          <div class="table-container">
            <table class="data-table" id="tasks-table">
              <thead>
                <tr>
                  <th>Task ID</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Progress</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tasks-tbody">
                <tr>
                  <td colspan="6" class="text-center text-muted">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Simulate Week Section -->
      <section id="section-simulate" class="section">
        <div class="card">
          <h3>Simulate Week</h3>
          <p class="text-muted">Build game payloads for all games in a season week.</p>

          <div class="form-grid">
            <div class="form-group">
              <label for="sim-year">League Year ID</label>
              <input type="number" id="sim-year" value="1" min="1" />
            </div>
            <div class="form-group">
              <label for="sim-week">Season Week</label>
              <input type="number" id="sim-week" value="1" min="1" />
            </div>
            <div class="form-group">
              <label for="sim-level">League Level (optional)</label>
              <select id="sim-level">
                <option value="">All levels</option>
                <option value="9">9 - MLB</option>
                <option value="8">8 - AAA</option>
                <option value="7">7 - AA</option>
              </select>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" id="btn-sim-preview">Preview (GET)</button>
            <button class="btn btn-warning" id="btn-sim-run">Run Simulation (POST)</button>
          </div>
        </div>

        <div class="card">
          <h3>Result</h3>
          <pre id="sim-result" class="result-box">No simulation run yet.</pre>
        </div>
      </section>

      <!-- Timestamp Section -->
      <section id="section-timestamp" class="section">
        <div class="card">
          <h3>Current Timestamp State</h3>
          <button class="btn btn-secondary" id="btn-refresh-timestamp" style="margin-bottom: 16px">Refresh</button>
          <div class="kv-table" id="timestamp-data">
            <div class="kv-row"><div class="kv-key">Loading...</div><div class="kv-val"></div></div>
          </div>
        </div>

        <div class="card">
          <h3>Timestamp Actions</h3>
          <div class="button-group">
            <button class="btn btn-warning" id="btn-advance-week">Advance Week</button>
            <button class="btn btn-secondary" id="btn-reset-week">Reset Week Games</button>
          </div>
          <pre id="timestamp-result" class="result-box" style="margin-top: 16px"></pre>
        </div>
      </section>

      <!-- Rating Config Section -->
      <section id="section-rating-config" class="section">
        <div class="grid-2">
          <div class="stat-card">
            <div class="stat-label">Config Status</div>
            <div class="stat-value" id="rc-status">--</div>
            <div class="stat-sub" id="rc-status-sub">Not loaded</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Levels Configured</div>
            <div class="stat-value" id="rc-levels-count">--</div>
            <div class="stat-sub" id="rc-attrs-count">--</div>
          </div>
        </div>

        <div class="card">
          <h3>Analyze Player Data</h3>
          <p class="text-muted">Compute statistical breakdowns from current player data. This populates the config table with suggested mean/std values and quartile reference data. You can then edit the values below.</p>

          <div class="alert alert-info">
            <strong>When to analyze:</strong> After importing new players, completing a draft, processing trades, or anytime you want fresh baseline numbers. Levels with no players (e.g. 1-3 before import) will be skipped.
          </div>

          <div class="button-group">
            <button class="btn btn-warning" id="btn-seed-config">Analyze &amp; Populate</button>
          </div>

          <pre id="rc-seed-result" class="result-box" style="margin-top: 16px; display: none"></pre>
        </div>

        <div class="card">
          <h3>Level Scale Config</h3>
          <p class="text-muted">Set one mean and std dev per level/type. These values are applied uniformly to all attributes at that level for 20-80 scale conversion.</p>

          <div class="button-group" style="margin-bottom: 16px">
            <button class="btn btn-primary" id="btn-load-config">Load Current</button>
            <button class="btn btn-warning" id="btn-save-config" style="display: none">Save Changes</button>
          </div>

          <div class="table-container">
            <table class="data-table" id="rc-config-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Level</th>
                  <th>Mean</th>
                  <th>Std Dev</th>
                  <th>20</th>
                  <th>50</th>
                  <th>80</th>
                </tr>
              </thead>
              <tbody id="rc-config-tbody">
                <tr>
                  <td colspan="7" class="text-center text-muted">Click "Load Current" to view</td>
                </tr>
              </tbody>
            </table>
          </div>

          <pre id="rc-save-result" class="result-box" style="margin-top: 12px; display: none"></pre>
        </div>

        <div class="card">
          <h3>Attribute Analysis (Reference)</h3>
          <p class="text-muted">Read-only breakdown from the last analysis. Use these numbers to inform your mean/std choices above.</p>

          <div class="form-row">
            <div class="form-group">
              <label for="rc-ptype-filter">Player Type</label>
              <select id="rc-ptype-filter">
                <option value="">All Types</option>
                <option value="Pitcher">Pitcher</option>
                <option value="Position">Position</option>
              </select>
            </div>
            <div class="form-group">
              <label for="rc-level-filter">Filter by Level</label>
              <select id="rc-level-filter">
                <option value="">All Levels</option>
                <option value="4">4 - Scraps</option>
                <option value="5">5 - A</option>
                <option value="6">6 - High-A</option>
                <option value="7">7 - AA</option>
                <option value="8">8 - AAA</option>
                <option value="9">9 - MLB</option>
              </select>
            </div>
            <div class="form-group">
              <label for="rc-attr-filter">Search Attribute</label>
              <input type="text" id="rc-attr-filter" placeholder="e.g. power, pitch_pacc" />
            </div>
            <div class="form-group" style="align-self: flex-end">
              <button class="btn btn-secondary" id="btn-load-analysis">Load</button>
            </div>
          </div>

          <div class="table-container">
            <table class="data-table" id="rc-analysis-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Level</th>
                  <th>Attribute</th>
                  <th>P25</th>
                  <th>Median</th>
                  <th>P75</th>
                  <th>Seed Mean</th>
                  <th>Seed Std</th>
                </tr>
              </thead>
              <tbody id="rc-analysis-tbody">
                <tr>
                  <td colspan="8" class="text-center text-muted">Click "Load" to view data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Overall Rating Weights</h3>
          <p class="text-muted">Configure the weighted average formula for pitcher and position player overall ratings. Weights should sum to 1.0. After editing, click Save then re-seed the config.</p>

          <div class="button-group" style="margin-bottom: 16px">
            <button class="btn btn-primary" id="btn-load-weights">Load Weights</button>
            <button class="btn btn-warning" id="btn-save-weights" style="display:none">Save Weights</button>
          </div>

          <div id="rc-weights-container" class="grid-2">
            <div class="text-center text-muted">Click "Load Weights" to view</div>
          </div>

          <pre id="rc-weights-result" class="result-box" style="margin-top: 16px; display: none"></pre>
        </div>
      </section>

      <!-- Organizations Section -->
      <section id="section-organizations" class="section">
        <div class="card">
          <h3>Organizations</h3>
          <div class="form-row">
            <select id="org-select" class="select-lg">
              <option value="">Select an organization...</option>
            </select>
            <button class="btn btn-secondary" id="btn-refresh-orgs">Refresh List</button>
          </div>
        </div>

        <div class="card" id="org-detail-card" style="display:none">
          <h3>Organization Details</h3>
          <div class="kv-table" id="org-detail"></div>
        </div>
      </section>

      <!-- Teams Section -->
      <section id="section-teams" class="section">
        <div class="card">
          <h3>Teams</h3>
          <div class="form-row">
            <select id="team-select" class="select-lg">
              <option value="">Select a team...</option>
            </select>
            <button class="btn btn-secondary" id="btn-refresh-teams">Refresh List</button>
          </div>
        </div>

        <div class="card" id="team-detail-card" style="display:none">
          <h3>Team Details</h3>
          <div class="kv-table" id="team-detail"></div>
          <button class="btn btn-secondary" id="btn-team-players" style="margin-top: 16px">View Players</button>
        </div>

        <div class="card" id="team-players-card" style="display:none">
          <h3>Team Players</h3>
          <pre id="team-players" class="result-box"></pre>
        </div>
      </section>

      <!-- Players Section -->
      <section id="section-players" class="section">
        <div class="card">
          <h3>Player Lookup</h3>
          <div class="form-row">
            <input type="number" id="player-id" placeholder="Enter Player ID" />
            <button class="btn btn-primary" id="btn-lookup-player">Lookup</button>
          </div>
        </div>

        <div class="card" id="player-detail-card" style="display:none">
          <h3>Player Details</h3>
          <pre id="player-detail" class="result-box"></pre>
        </div>
      </section>

      <!-- Cache Manager Section -->
      <section id="section-cache" class="section">
        <div class="card">
          <h3>Cache Manager</h3>
          <p class="text-muted">Clear in-memory caches after making database changes. This ensures the API returns fresh data.</p>

          <div class="alert alert-info">
            <strong>Cached data includes:</strong> Level configs, catch rates, game constants, injury types, player column categories, and reflected database tables.
          </div>

          <div class="button-group">
            <button class="btn btn-warning" id="btn-clear-cache">Clear All Caches</button>
          </div>

          <pre id="cache-result" class="result-box" style="margin-top: 16px"></pre>
        </div>
      </section>

      <!-- SQL Console Section -->
      <section id="section-sql" class="section">
        <div class="card">
          <h3>SQL Console</h3>

          <div class="form-row" style="margin-bottom: 16px">
            <label>Presets:
              <select id="sql-preset">
                <option value="">-- Select preset --</option>
              </select>
            </label>
            <button class="btn btn-secondary" id="btn-run-preset">Run Preset</button>
          </div>

          <div class="form-row" style="margin-bottom: 16px">
            <label>Mode:
              <select id="sql-mode">
                <option value="read">Read-only</option>
                <option value="write">Write (if enabled)</option>
              </select>
            </label>
            <label>Row limit:
              <input type="number" id="sql-limit" value="100" min="1" max="5000" style="width: 80px" />
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="sql-dry" checked />
              Dry run (writes)
            </label>
          </div>

          <textarea id="sql-query" placeholder="SELECT * FROM simbbPlayers LIMIT 10;"></textarea>

          <div class="button-group">
            <button class="btn btn-primary" id="btn-run-sql">Run Query</button>
          </div>
        </div>

        <div class="card">
          <h3>Result</h3>
          <pre id="sql-result" class="result-box">No query executed yet.</pre>
        </div>
      </section>

      <!-- System Health Section -->
      <section id="section-health" class="section">
        <div class="grid-2">
          <div class="card">
            <h3>Health Check</h3>
            <div class="health-status" id="health-status">
              <span class="status-indicator" id="health-indicator"></span>
              <span id="health-text">Checking...</span>
            </div>
            <button class="btn btn-secondary" id="btn-check-health" style="margin-top: 16px">Refresh</button>
          </div>

          <div class="card">
            <h3>Database Info</h3>
            <pre id="db-info" class="result-box">Loading...</pre>
          </div>
        </div>

        <div class="card">
          <h3>Available Routes</h3>
          <pre id="routes-list" class="result-box" style="max-height: 400px">Loading...</pre>
        </div>
      </section>

      <!-- Roster Moves Section -->
      <section id="section-tx-roster" class="section">
        <div class="grid-2">
          <div class="card">
            <h3>Select Organization</h3>
            <div class="form-row">
              <select id="tx-org-select" class="select-lg">
                <option value="">Select an organization...</option>
              </select>
              <button class="btn btn-secondary" id="btn-tx-load-roster">Load Roster</button>
            </div>
          </div>
          <div class="card">
            <h3>Roster Status</h3>
            <div id="tx-roster-status" class="text-muted">Select an org to view roster counts.</div>
          </div>
        </div>

        <div class="card" id="tx-roster-card" style="display:none">
          <h3>Roster</h3>
          <div class="form-row" style="margin-bottom: 12px">
            <label>Filter Level:
              <select id="tx-roster-level-filter">
                <option value="">All Levels</option>
                <option value="9">MLB</option>
                <option value="8">AAA</option>
                <option value="7">AA</option>
                <option value="6">High-A</option>
                <option value="5">A</option>
                <option value="4">Scraps</option>
              </select>
            </label>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Pos</th>
                  <th>Level</th>
                  <th>Contract</th>
                  <th>Salary</th>
                  <th>IR</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tx-roster-tbody">
                <tr><td colspan="7" class="text-center text-muted">No roster loaded</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" id="tx-action-card" style="display:none">
          <h3>Player Action: <span id="tx-action-player-name"></span></h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Action</label>
              <select id="tx-action-type">
                <option value="">Select action...</option>
                <option value="promote">Promote</option>
                <option value="demote">Demote</option>
                <option value="ir_place">Place on IR</option>
                <option value="ir_activate">Activate from IR</option>
                <option value="release">Release</option>
                <option value="buyout">Buyout</option>
                <option value="extend">Extend Contract</option>
              </select>
            </div>
            <div class="form-group" id="tx-target-level-group" style="display:none">
              <label>Target Level</label>
              <select id="tx-target-level">
                <option value="9">MLB</option>
                <option value="8">AAA</option>
                <option value="7">AA</option>
                <option value="6">High-A</option>
                <option value="5">A</option>
                <option value="4">Scraps</option>
              </select>
            </div>
            <div class="form-group" id="tx-buyout-group" style="display:none">
              <label>Buyout Amount ($)</label>
              <input type="number" id="tx-buyout-amount" min="0" step="1000" />
            </div>
          </div>
          <div id="tx-extend-group" style="display:none">
            <div class="form-grid">
              <div class="form-group">
                <label>Extension Years</label>
                <input type="number" id="tx-ext-years" min="1" max="5" value="1" />
              </div>
              <div class="form-group">
                <label>Signing Bonus ($)</label>
                <input type="number" id="tx-ext-bonus" min="0" step="1000" value="0" />
              </div>
            </div>
            <div id="tx-ext-salaries" class="form-grid"></div>
          </div>
          <div class="button-group" style="margin-top: 12px">
            <button class="btn btn-warning" id="btn-tx-execute-action">Execute</button>
          </div>
          <pre id="tx-action-result" class="result-box" style="margin-top: 12px; display:none"></pre>
        </div>

        <div class="card">
          <h3>Free Agent Signing</h3>
          <div class="button-group" style="margin-bottom: 12px">
            <button class="btn btn-secondary" id="btn-tx-load-fa">Load Free Agents</button>
            <span id="tx-signing-budget" class="text-muted" style="margin-left: 16px"></span>
          </div>
          <div class="table-container" id="tx-fa-table-wrap" style="display:none">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Pos</th>
                  <th>Age</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tx-fa-tbody"></tbody>
            </table>
          </div>
          <div id="tx-sign-form" style="display:none; margin-top: 16px">
            <h4>Sign: <span id="tx-sign-player-name"></span></h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Years</label>
                <input type="number" id="tx-sign-years" min="1" max="5" value="1" />
              </div>
              <div class="form-group">
                <label>Bonus ($)</label>
                <input type="number" id="tx-sign-bonus" min="0" step="1000" value="0" />
              </div>
              <div class="form-group">
                <label>Assign Level</label>
                <select id="tx-sign-level">
                  <option value="9">MLB</option>
                  <option value="8">AAA</option>
                  <option value="7">AA</option>
                  <option value="6">High-A</option>
                  <option value="5">A</option>
                  <option value="4">Scraps</option>
                </select>
              </div>
            </div>
            <div id="tx-sign-salaries" class="form-grid"></div>
            <div class="button-group" style="margin-top: 8px">
              <button class="btn btn-primary" id="btn-tx-sign">Sign Player</button>
            </div>
            <pre id="tx-sign-result" class="result-box" style="margin-top: 12px; display:none"></pre>
          </div>
        </div>
      </section>

      <!-- Trades Section -->
      <section id="section-tx-trades" class="section">
        <div class="card">
          <h3>Trade Builder</h3>
          <p class="text-muted">Select two organizations and build a trade package.</p>
          <div class="trade-builder">
            <div class="trade-side">
              <h4>Organization A</h4>
              <select id="tx-trade-org-a" class="select-lg">
                <option value="">Select org...</option>
              </select>
              <div class="table-container" style="margin-top: 8px">
                <table class="data-table">
                  <thead><tr><th></th><th>Player</th><th>Pos</th><th>Level</th></tr></thead>
                  <tbody id="tx-trade-roster-a">
                    <tr><td colspan="4" class="text-center text-muted">Select org</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="trade-side">
              <h4>Organization B</h4>
              <select id="tx-trade-org-b" class="select-lg">
                <option value="">Select org...</option>
              </select>
              <div class="table-container" style="margin-top: 8px">
                <table class="data-table">
                  <thead><tr><th></th><th>Player</th><th>Pos</th><th>Level</th></tr></thead>
                  <tbody id="tx-trade-roster-b">
                    <tr><td colspan="4" class="text-center text-muted">Select org</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="form-grid" style="margin-top: 16px">
            <div class="form-group">
              <label>Cash A sends to B ($)</label>
              <input type="number" id="tx-trade-cash" value="0" step="10000" />
            </div>
          </div>
          <div class="button-group" style="margin-top: 12px">
            <button class="btn btn-warning" id="btn-tx-execute-trade">Execute Trade (Admin)</button>
          </div>
          <pre id="tx-trade-result" class="result-box" style="margin-top: 12px; display:none"></pre>
        </div>

        <div class="card">
          <h3>Trade Proposals</h3>
          <div class="form-row" style="margin-bottom: 12px">
            <label>Filter Status:
              <select id="tx-proposal-status-filter">
                <option value="">All</option>
                <option value="proposed">Proposed</option>
                <option value="counterparty_accepted">Awaiting Admin</option>
                <option value="executed">Executed</option>
                <option value="counterparty_rejected">Rejected</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </label>
            <button class="btn btn-secondary" id="btn-tx-load-proposals">Refresh</button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Status</th>
                  <th>Proposed</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tx-proposals-tbody">
                <tr><td colspan="6" class="text-center text-muted">Click Refresh to load</td></tr>
              </tbody>
            </table>
          </div>
          <pre id="tx-proposal-result" class="result-box" style="margin-top: 12px; display:none"></pre>
        </div>
      </section>

      <!-- Transaction Log Section -->
      <section id="section-tx-log" class="section">
        <div class="card">
          <h3>Transaction Log</h3>
          <div class="form-row" style="margin-bottom: 12px">
            <label>Type:
              <select id="tx-log-type-filter">
                <option value="">All Types</option>
                <option value="promote">Promote</option>
                <option value="demote">Demote</option>
                <option value="ir_place">IR Place</option>
                <option value="ir_activate">IR Activate</option>
                <option value="release">Release</option>
                <option value="buyout">Buyout</option>
                <option value="signing">Signing</option>
                <option value="extension">Extension</option>
                <option value="trade">Trade</option>
              </select>
            </label>
            <label>Org ID:
              <input type="number" id="tx-log-org-filter" placeholder="Any" style="width: 80px" />
            </label>
            <label>Limit:
              <input type="number" id="tx-log-limit" value="50" min="1" max="500" style="width: 80px" />
            </label>
            <button class="btn btn-secondary" id="btn-tx-load-log">Refresh</button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Org</th>
                  <th>Player</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tx-log-tbody">
                <tr><td colspan="7" class="text-center text-muted">Click Refresh to load</td></tr>
              </tbody>
            </table>
          </div>
          <pre id="tx-log-detail" class="result-box" style="margin-top: 12px; display:none"></pre>
        </div>
      </section>

      <!-- ── End of Season ────────────────────────────────────── -->
      <section id="section-tx-eos" class="section">
        <div class="card">
          <h3>Run End of Season</h3>
          <p class="text-muted">Process all end-of-season contract operations: credit MLB service time, advance mid-contract years, handle expirations (extensions, auto-renewals, free agency).</p>

          <div class="alert alert-info" id="eos-season-info">
            Loading current season info...
          </div>

          <div class="button-group">
            <button class="btn btn-warning" id="btn-eos-run">Process End of Season</button>
          </div>

          <div id="eos-result-card" style="display:none; margin-top: 16px">
            <h4>Processing Summary</h4>
            <div class="kv-table" id="eos-result"></div>
          </div>
        </div>

        <div class="card">
          <h3>Service Time Overview</h3>
          <div class="form-row" style="margin-bottom: 12px">
            <select id="eos-org-select" class="select-lg">
              <option value="">Select an organization...</option>
            </select>
            <button class="btn btn-secondary" id="btn-eos-load-overview">Load</button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Pos</th>
                  <th>Age</th>
                  <th>Level</th>
                  <th>Svc Yrs</th>
                  <th>Phase</th>
                  <th>Contract</th>
                  <th>Salary</th>
                  <th>Expiring</th>
                </tr>
              </thead>
              <tbody id="eos-overview-tbody">
                <tr><td colspan="9" class="text-center text-muted">Select an org to view</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ── Amateur Contract Seeding ────────────────────────── -->
      <section id="section-tx-amateur" class="section">
        <div class="card">
          <h3>Amateur Player Need</h3>
          <p class="text-muted">Scan uncontracted players by category to see how many need HS, INTAM, and College assignments.</p>
          <div class="button-group" style="margin-bottom: 16px">
            <button class="btn btn-secondary" id="btn-amateur-preview">Scan Players</button>
          </div>
          <div id="amateur-preview" style="display:none">
            <div class="grid-3" id="amateur-summary-cards"></div>
            <div class="card" style="margin-top: 16px">
              <h4>Breakdown</h4>
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Org</th>
                      <th>Age Range</th>
                      <th>Pitchers</th>
                      <th>Batters</th>
                      <th>Total</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="amateur-breakdown-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Seed Amateur Contracts</h3>
          <p class="text-muted">Create contracts for all uncontracted players, assigning them to HS, INTAM, and College organizations. This is idempotent — running again will only process newly uncontracted players.</p>
          <div class="alert alert-info">
            Requires <code>ALLOW_CONTRACT_SEEDING=true</code> environment variable.
          </div>
          <div class="button-group">
            <button class="btn btn-warning" id="btn-amateur-seed">Seed Amateur Contracts</button>
          </div>
          <div id="amateur-seed-result" style="display:none; margin-top: 16px">
            <h4>Seeding Summary</h4>
            <div class="kv-table" id="amateur-seed-kv"></div>
          </div>
        </div>
      </section>

      <!-- ── Player Engine: Generation ────────────────────────── -->
      <section id="section-pe-generate" class="section">
        <div class="card">
          <h3>Generate Players</h3>
          <div class="form-row" style="margin-bottom: 12px">
            <label>Count:
              <input type="number" id="pe-gen-count" value="1" min="1" max="5000" style="width: 80px" />
            </label>
            <label>Starting Age:
              <input type="number" id="pe-gen-age" value="15" min="14" max="45" style="width: 80px" />
            </label>
            <button class="btn btn-primary" id="btn-pe-generate">Generate</button>
          </div>
          <div id="pe-gen-status" class="text-muted" style="margin-bottom: 8px"></div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Age</th>
                  <th>Region</th>
                </tr>
              </thead>
              <tbody id="pe-gen-tbody">
                <tr><td colspan="5" class="text-center text-muted">No players generated yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Seed Tables Status</h3>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Table</th>
                  <th>Rows</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="pe-seed-tbody">
                <tr><td colspan="3" class="text-center text-muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ── Player Engine: Progression ───────────────────────── -->
      <section id="section-pe-progress" class="section">
        <div class="card">
          <h3>Batch Progression</h3>
          <p class="text-muted" style="margin-bottom: 12px">Progress every player in the database by one year. This is a major operation — use with care.</p>
          <div class="form-row" style="margin-bottom: 12px">
            <label>Max Age:
              <input type="number" id="pe-prog-max-age" value="45" min="16" max="60" style="width: 80px" />
            </label>
            <button class="btn btn-primary" id="btn-pe-progress-all">Progress All Players</button>
          </div>
          <div id="pe-prog-all-status" class="text-muted"></div>
        </div>

        <div class="card">
          <h3>Single Player Progression</h3>
          <div class="form-row" style="margin-bottom: 12px">
            <label>Player ID:
              <input type="number" id="pe-prog-pid" placeholder="e.g. 42" style="width: 100px" />
            </label>
            <button class="btn btn-secondary" id="btn-pe-progress-one">Progress</button>
          </div>
          <div id="pe-prog-one-status" class="text-muted"></div>
        </div>
      </section>

      <!-- ── Player Engine: Progression Sandbox ─────────────────── -->
      <section id="section-pe-sandbox" class="section">
        <div class="card">
          <h3>Progression Sandbox</h3>
          <p class="text-muted" style="margin-bottom: 12px">
            Simulate player progression in-memory without affecting the database.
            Generate synthetic players and chart their growth across multiple seasons.
          </p>

          <div class="form-row" style="margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
            <label>Players:
              <input type="number" id="sandbox-count" value="200" min="10" max="2000" style="width: 80px" />
            </label>
            <label>Seasons:
              <input type="number" id="sandbox-seasons" value="20" min="1" max="30" style="width: 60px" />
            </label>
            <label>Start Age:
              <input type="number" id="sandbox-start-age" value="15" min="14" max="30" style="width: 60px" />
            </label>
            <label>Player Type:
              <select id="sandbox-ptype" style="width: 100px">
                <option value="Both">Both</option>
                <option value="Pitcher">Pitcher</option>
                <option value="Position">Position</option>
              </select>
            </label>
            <button class="btn btn-primary" id="btn-sandbox-run">Run Simulation</button>
          </div>

          <div id="sandbox-status" class="text-muted" style="margin-bottom: 8px"></div>
        </div>

        <div class="card" id="sandbox-chart-card" style="display: none;">
          <div class="form-row" style="margin-bottom: 12px; gap: 12px; align-items: center; flex-wrap: wrap;">
            <label>Ability:
              <select id="sandbox-ability-select" style="width: 150px"></select>
            </label>
            <label style="display: flex; align-items: center; gap: 4px;">
              <input type="checkbox" id="sandbox-show-bands" checked /> P10-P90 bands
            </label>
            <label style="display: flex; align-items: center; gap: 4px;">
              <input type="checkbox" id="sandbox-show-players" /> Individual players
            </label>
            <label id="sandbox-grade-filter-label" style="display: none;">Grade:
              <select id="sandbox-grade-filter" style="width: 80px">
                <option value="__all__">All</option>
              </select>
            </label>
            <label id="sandbox-highlight-label" style="display: none;">Highlight:
              <select id="sandbox-highlight-player" style="width: 100px">
                <option value="">None</option>
              </select>
            </label>
          </div>
          <div style="position: relative; height: 420px;">
            <canvas id="sandbox-chart"></canvas>
          </div>
        </div>

        <div class="card" id="sandbox-summary-card" style="display: none;">
          <h3>Grade Distribution</h3>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Grade</th>
                  <th>Players</th>
                  <th>Final Avg</th>
                  <th>Peak Avg</th>
                  <th>Best Individual</th>
                  <th>Worst Individual</th>
                </tr>
              </thead>
              <tbody id="sandbox-grade-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </main>

  <script src="{{ url_for('admin.static', filename='app.js') }}"></script>
</body>

</html>
